// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Generated from main.tsp and openapi.yaml specifications

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================
// Enums
// ============================================

/// 인증 방법 (소셜 로그인 및 이메일 인증)
enum AuthenticationMethod {
  EMAIL
  KAKAO
  NAVER
  APPLE
  GOOGLE
}

/// 사용자 계정 상태
enum UserStatus {
  ACTIVE
  SLEEP
  SUSPENDED
  DELETED
}

/// 앱 실행 플랫폼
enum Platform {
  IOS     @map("iOS")
  ANDROID @map("Android")
  WEB     @map("Web")
}

// ============================================
// Models
// ============================================

/// 통합 사용자 정보 모델
model User {
  /// 사용자 고유 ID (UUID)
  id        String   @id @default(uuid())

  /// 이메일 주소 (소셜 계정만 있는 경우 없을 수 있음)
  email     String?  @unique

  /// 닉네임
  nickname  String

  /// 계정 상태
  status    UserStatus @default(ACTIVE)

  /// 마케팅 수신 동의
  marketingConsent Boolean @default(false)

  /// 최초 가입일
  createdAt DateTime @default(now())

  /// 마지막 로그인 시간
  lastLogin DateTime?

  /// 마지막 업데이트 시간
  updatedAt DateTime @updatedAt

  // Relations
  authenticationAccounts AuthenticationAccount[]
  refreshTokens          RefreshToken[]
  devices                Device[]
  passwordResetTokens    PasswordResetToken[]

  @@map("users")
}

/// 인증 수단과 사용자를 연결하는 모델 (EMAIL 및 소셜 계정 통합)
model AuthenticationAccount {
  /// 고유 ID
  id           String   @id @default(uuid())

  /// 인증 방법
  method       AuthenticationMethod

  /// 제공자별 고유 ID (소셜: 외부 제공자의 사용자 ID, EMAIL: 미사용)
  providerId   String?

  /// 비밀번호 해시 값 (bcrypt/argon2 등, EMAIL 인증시에만 사용)
  /// 주의: 이 필드는 해시된 값만 저장하며, 평문 비밀번호는 절대 저장하지 않음
  passwordHash String?

  /// 연결된 사용자 ID (FK)
  userId       String

  /// 생성일
  createdAt    DateTime @default(now())

  /// 업데이트일
  updatedAt    DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  // 동일 인증 방법 + 제공자 ID 조합은 유일해야 함
  @@unique([method, providerId])
  // 한 사용자는 동일 인증 방법을 한 번만 연결 가능
  @@unique([userId, method])
  @@index([userId])
  @@map("authentication_accounts")
}

/// 리프레시 토큰 관리 모델
model RefreshToken {
  /// 고유 ID
  id           String   @id @default(uuid())

  /// 토큰 값 (해시된 값으로 저장)
  tokenHash    String   @unique

  /// 연결된 사용자 ID (FK)
  userId       String

  /// 디바이스 ID (FK)
  deviceId     String?

  /// 토큰 만료 시간
  expiresAt    DateTime

  /// 토큰 사용 횟수 (Rotation 정책용)
  usageCount   Int      @default(0)

  /// 최대 사용 횟수 제한 (null이면 무제한)
  maxUsageCount Int?

  /// 토큰 무효화 여부
  isRevoked    Boolean  @default(false)

  /// 무효화 사유
  revokedReason String?

  /// 무효화 시간
  revokedAt    DateTime?

  /// 생성일
  createdAt    DateTime @default(now())

  /// 마지막 사용 시간
  lastUsedAt   DateTime?

  // Relations
  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  device Device? @relation(fields: [deviceId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([expiresAt])
  @@index([isRevoked])
  @@map("refresh_tokens")
}

/// 디바이스 정보 모델
model Device {
  /// 고유 ID
  id          String   @id @default(uuid())

  /// 디바이스 식별자 (클라이언트에서 제공)
  deviceId    String

  /// 연결된 사용자 ID (FK)
  userId      String

  /// 플랫폼
  platform    Platform

  /// 앱 버전
  appVersion  String

  /// 푸시 토큰 (선택)
  pushToken   String?

  /// 마지막 활성 시간
  lastActiveAt DateTime @default(now())

  /// 생성일
  createdAt   DateTime @default(now())

  /// 업데이트일
  updatedAt   DateTime @updatedAt

  // Relations
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  refreshTokens RefreshToken[]

  // 사용자별 디바이스 ID는 유일해야 함
  @@unique([userId, deviceId])
  @@index([userId])
  @@map("devices")
}

/// 비밀번호 재설정 토큰 모델
model PasswordResetToken {
  /// 고유 ID
  id        String   @id @default(uuid())

  /// 토큰 값 (해시된 값으로 저장)
  tokenHash String   @unique

  /// 연결된 사용자 ID (FK)
  userId    String

  /// 토큰 만료 시간
  expiresAt DateTime

  /// 사용 여부
  isUsed    Boolean  @default(false)

  /// 사용 시간
  usedAt    DateTime?

  /// 생성일
  createdAt DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@map("password_reset_tokens")
}

/// 앱 시스템 설정 정보 모델
model AppConfig {
  /// 고유 ID
  id              String  @id @default(uuid())

  /// 설정 키 (예: "global", "ios", "android")
  configKey       String  @unique

  /// 최소 지원 버전
  minVersion      String

  /// 점검 모드 여부
  maintenanceMode Boolean @default(false)

  /// 공지 메시지
  noticeMessage   String?

  /// 생성일
  createdAt       DateTime @default(now())

  /// 업데이트일
  updatedAt       DateTime @updatedAt

  @@map("app_configs")
}
